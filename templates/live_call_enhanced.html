{% extends "base.html" %}

{% block title %}{{ 'Chamada ao Vivo' if lang == 'pt' else 'Live Call' }} - {{ translations.app_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Live Call Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2">
                        <i class="fas fa-phone me-3 text-success"></i>
                        {{ 'Assistente de Chamada ao Vivo' if lang == 'pt' else 'Live Call Assistant' }}
                    </h1>
                    <p class="text-muted">{{ 'Receba orientações em tempo real durante suas negociações' if lang == 'pt' else 'Get real-time guidance during your negotiations' }}</p>
                </div>
                <div>
                    <button class="btn btn-success btn-lg" id="startCallBtn">
                        <i class="fas fa-play me-2"></i>
                        {{ 'Iniciar Chamada' if lang == 'pt' else 'Start Call' }}
                    </button>
                    <button class="btn btn-danger btn-lg d-none" id="endCallBtn">
                        <i class="fas fa-stop me-2"></i>
                        {{ 'Finalizar Chamada' if lang == 'pt' else 'End Call' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Status -->
    <div class="row mb-4" id="callStatus" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="status-indicator bg-success me-3"></div>
                                <div>
                                    <h6 class="mb-0">{{ 'Chamada Ativa' if lang == 'pt' else 'Call Active' }}</h6>
                                    <small class="text-muted" id="callTimer">00:00</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="customer-info">
                                <h6 class="mb-1">Maria Santos</h6>
                                <p class="mb-0 text-muted">{{ 'Débito: R$ 5,200 | Vencido há 45 dias' if lang == 'pt' else 'Debt: R$ 5,200 | 45 days overdue' }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-end">
                                <span class="badge bg-warning fs-6">{{ 'Probabilidade: 70%' if lang == 'pt' else 'Probability: 70%' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="row">
        <!-- Input Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        {{ 'Entrada de Informações' if lang == 'pt' else 'Information Input' }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Quick Buttons -->
                    <div class="mb-4">
                        <h6>{{ 'Situação do Cliente:' if lang == 'pt' else 'Customer Situation:' }}</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-lg mb-2 situation-btn" data-situation="cant_pay">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ 'Não pode pagar' if lang == 'pt' else "Can't pay" }}
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-lg mb-2 situation-btn" data-situation="wants_discount">
                                <i class="fas fa-percentage me-2"></i>
                                {{ 'Quer desconto' if lang == 'pt' else 'Wants discount' }}
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-lg mb-2 situation-btn" data-situation="angry">
                                <i class="fas fa-angry me-2"></i>
                                {{ 'Cliente irritado' if lang == 'pt' else 'Angry customer' }}
                            </button>
                            <button type="button" class="btn btn-outline-success btn-lg mb-2 situation-btn" data-situation="interested">
                                <i class="fas fa-handshake me-2"></i>
                                {{ 'Interessado em negociar' if lang == 'pt' else 'Interested in negotiating' }}
                            </button>
                        </div>
                    </div>

                    <!-- Text Input -->
                    <div class="mb-4">
                        <label for="customerInput" class="form-label">
                            <h6>{{ 'O que o cliente disse?' if lang == 'pt' else 'What did the customer say?' }}</h6>
                        </label>
                        <textarea class="form-control form-control-lg" id="customerInput" rows="4" 
                                  placeholder="{{ 'Digite aqui o que o cliente falou...' if lang == 'pt' else 'Type here what the customer said...' }}"></textarea>
                    </div>

                    <!-- Voice Input -->
                    <div class="mb-4">
                        <button class="btn btn-info btn-lg w-100" id="voiceInputBtn">
                            <i class="fas fa-microphone me-2"></i>
                            {{ 'Clique e Fale' if lang == 'pt' else 'Click and Speak' }}
                        </button>
                        <small class="text-muted d-block mt-2">
                            {{ 'Pressione e segure para gravar sua voz' if lang == 'pt' else 'Press and hold to record your voice' }}
                        </small>
                    </div>

                    <!-- Analyze Button -->
                    <button class="btn btn-primary btn-lg w-100" id="analyzeBtn">
                        <i class="fas fa-brain me-2"></i>
                        {{ 'Analisar e Obter Recomendações' if lang == 'pt' else 'Analyze and Get Recommendations' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Recommendations -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        {{ 'Recomendações do AI' if lang == 'pt' else 'AI Recommendations' }}
                    </h5>
                </div>
                <div class="card-body" id="recommendationsPanel">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <p>{{ 'Aguardando informações do cliente para gerar recomendações...' if lang == 'pt' else 'Waiting for customer information to generate recommendations...' }}</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        {{ 'Ações Rápidas' if lang == 'pt' else 'Quick Actions' }}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="openCalculator()">
                            <i class="fas fa-calculator me-2"></i>
                            {{ 'Calculadora' if lang == 'pt' else 'Calculator' }}
                        </button>
                        <button class="btn btn-outline-info" onclick="openScripts()">
                            <i class="fas fa-file-alt me-2"></i>
                            {{ 'Scripts' if lang == 'pt' else 'Scripts' }}
                        </button>
                        <button class="btn btn-outline-warning" onclick="checkCompliance()">
                            <i class="fas fa-shield-alt me-2"></i>
                            {{ 'Compliance' if lang == 'pt' else 'Compliance' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row mt-4" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        {{ 'Resultado da Chamada' if lang == 'pt' else 'Call Result' }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">{{ 'Resultado:' if lang == 'pt' else 'Result:' }}</label>
                            <select class="form-select form-select-lg">
                                <option>{{ 'Pagamento completo' if lang == 'pt' else 'Full payment' }}</option>
                                <option>{{ 'Parcelamento acordado' if lang == 'pt' else 'Installment agreed' }}</option>
                                <option>{{ 'Promessa de pagamento' if lang == 'pt' else 'Payment promise' }}</option>
                                <option>{{ 'Sem acordo' if lang == 'pt' else 'No agreement' }}</option>
                                <option>{{ 'Reagendar' if lang == 'pt' else 'Reschedule' }}</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">{{ 'Valor acordado:' if lang == 'pt' else 'Agreed amount:' }}</label>
                            <input type="text" class="form-control form-control-lg" placeholder="R$ 0,00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">{{ 'Próxima ação:' if lang == 'pt' else 'Next action:' }}</label>
                            <input type="datetime-local" class="form-control form-control-lg">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>
                            {{ 'Salvar Resultado' if lang == 'pt' else 'Save Result' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let callActive = false;
let callStartTime = null;
let callTimer = null;

// Start Call
document.getElementById('startCallBtn').addEventListener('click', function() {
    callActive = true;
    callStartTime = new Date();
    
    // Toggle buttons
    document.getElementById('startCallBtn').classList.add('d-none');
    document.getElementById('endCallBtn').classList.remove('d-none');
    
    // Show call status
    document.getElementById('callStatus').style.display = 'block';
    
    // Start timer
    callTimer = setInterval(updateCallTimer, 1000);
    
    // Show success message
    showNotification('{{ "Chamada iniciada! AI Companion ativo." if lang == "pt" else "Call started! AI Companion active." }}', 'success');
});

// End Call
document.getElementById('endCallBtn').addEventListener('click', function() {
    callActive = false;
    
    // Toggle buttons
    document.getElementById('endCallBtn').classList.add('d-none');
    document.getElementById('startCallBtn').classList.remove('d-none');
    
    // Hide call status
    document.getElementById('callStatus').style.display = 'none';
    
    // Stop timer
    clearInterval(callTimer);
    
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    
    showNotification('{{ "Chamada finalizada. Registre o resultado." if lang == "pt" else "Call ended. Please record the result." }}', 'info');
});

// Update call timer
function updateCallTimer() {
    if (callStartTime) {
        const now = new Date();
        const diff = Math.floor((now - callStartTime) / 1000);
        const minutes = Math.floor(diff / 60);
        const seconds = diff % 60;
        document.getElementById('callTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// Situation buttons
document.querySelectorAll('.situation-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.situation-btn').forEach(b => b.classList.remove('active'));
        // Add active class to clicked button
        this.classList.add('active');
        
        // Generate recommendation based on situation
        const situation = this.getAttribute('data-situation');
        generateRecommendation(situation);
    });
});

// Analyze button
document.getElementById('analyzeBtn').addEventListener('click', function() {
    const input = document.getElementById('customerInput').value;
    if (input.trim()) {
        generateRecommendationFromText(input);
    } else {
        showNotification('{{ "Por favor, digite o que o cliente disse." if lang == "pt" else "Please type what the customer said." }}', 'warning');
    }
});

// Voice input (mock)
document.getElementById('voiceInputBtn').addEventListener('click', function() {
    showNotification('{{ "Funcionalidade de voz será implementada em breve." if lang == "pt" else "Voice functionality will be implemented soon." }}', 'info');
});

// Generate recommendation based on situation
function generateRecommendation(situation) {
    const recommendations = {
        'cant_pay': {
            'pt': {
                priority: 'ALTA',
                color: 'danger',
                title: 'Cliente sem condições de pagamento',
                suggestion: 'Ofereça parcelamento em até 12x com desconto de 20% para pagamento à vista.',
                script: '"Entendo sua situação. Que tal dividirmos em parcelas menores? Posso oferecer 12x de R$ 350."'
            },
            'en': {
                priority: 'HIGH',
                color: 'danger',
                title: 'Customer unable to pay',
                suggestion: 'Offer installments up to 12x with 20% discount for cash payment.',
                script: '"I understand your situation. How about smaller installments? I can offer 12x of R$ 350."'
            }
        },
        'wants_discount': {
            'pt': {
                priority: 'MÉDIA',
                color: 'warning',
                title: 'Cliente quer desconto',
                suggestion: 'Ofereça desconto progressivo: 10% à vista, 5% em 3x.',
                script: '"Posso oferecer 10% de desconto para pagamento à vista hoje. Fica R$ 4.680."'
            },
            'en': {
                priority: 'MEDIUM',
                color: 'warning',
                title: 'Customer wants discount',
                suggestion: 'Offer progressive discount: 10% cash, 5% in 3x.',
                script: '"I can offer 10% discount for cash payment today. That would be R$ 4,680."'
            }
        },
        'angry': {
            'pt': {
                priority: 'ALTA',
                color: 'danger',
                title: 'Cliente irritado',
                suggestion: 'Use abordagem empática. Escute primeiro, depois ofereça soluções.',
                script: '"Entendo sua frustração. Vamos encontrar uma solução que funcione para você."'
            },
            'en': {
                priority: 'HIGH',
                color: 'danger',
                title: 'Angry customer',
                suggestion: 'Use empathetic approach. Listen first, then offer solutions.',
                script: '"I understand your frustration. Let\'s find a solution that works for you."'
            }
        },
        'interested': {
            'pt': {
                priority: 'BAIXA',
                color: 'success',
                title: 'Cliente interessado',
                suggestion: 'Aproveite o momento. Ofereça a melhor condição disponível.',
                script: '"Ótimo! Posso oferecer condições especiais para fecharmos hoje."'
            },
            'en': {
                priority: 'LOW',
                color: 'success',
                title: 'Interested customer',
                suggestion: 'Seize the moment. Offer the best available terms.',
                script: '"Great! I can offer special terms to close this today."'
            }
        }
    };
    
    const lang = '{{ lang }}';
    const rec = recommendations[situation][lang];
    
    const panel = document.getElementById('recommendationsPanel');
    panel.innerHTML = `
        <div class="alert alert-${rec.color} mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <strong>🔴 PRIORIDADE ${rec.priority}</strong>
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
        
        <div class="recommendation-item mb-3">
            <h6><i class="fas fa-lightbulb me-2"></i>${rec.title}</h6>
            <p class="text-muted">${rec.suggestion}</p>
        </div>
        
        <div class="script-suggestion">
            <h6><i class="fas fa-quote-left me-2"></i>${lang === 'pt' ? 'Script Sugerido:' : 'Suggested Script:'}</h6>
            <div class="alert alert-light">
                <em>${rec.script}</em>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="copyScript('${rec.script}')">
                <i class="fas fa-copy me-1"></i>${lang === 'pt' ? 'Copiar' : 'Copy'}
            </button>
        </div>
    `;
}

// Generate recommendation from text
function generateRecommendationFromText(text) {
    // Simple keyword analysis (in real implementation, this would use AI)
    const keywords = text.toLowerCase();
    
    if (keywords.includes('não posso') || keywords.includes('sem dinheiro')) {
        generateRecommendation('cant_pay');
    } else if (keywords.includes('desconto') || keywords.includes('redução')) {
        generateRecommendation('wants_discount');
    } else if (keywords.includes('irritado') || keywords.includes('raiva')) {
        generateRecommendation('angry');
    } else {
        generateRecommendation('interested');
    }
}

// Copy script to clipboard
function copyScript(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('{{ "Script copiado!" if lang == "pt" else "Script copied!" }}', 'success');
    });
}

// Quick actions
function openCalculator() {
    showNotification('{{ "Calculadora será aberta em breve." if lang == "pt" else "Calculator will open soon." }}', 'info');
}

function openScripts() {
    showNotification('{{ "Biblioteca de scripts será aberta em breve." if lang == "pt" else "Script library will open soon." }}', 'info');
}

function checkCompliance() {
    showNotification('{{ "Verificação de compliance OK ✓" if lang == "pt" else "Compliance check OK ✓" }}', 'success');
}

// Show notification
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.situation-btn.active {
    background-color: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

.recommendation-item {
    border-left: 4px solid #007bff;
    padding-left: 15px;
}

.script-suggestion {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}
</style>
{% endblock %}

